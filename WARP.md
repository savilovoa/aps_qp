# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

Project overview
- Python/FastAPI server планирования расписания производства

Главная библиотека для расчета расписания - ortools
pydantic - используется для API

Реализован один расчет @router.post("/plan") для ткацкого производства (функция create_model)

Описание модели:
существующая модель для планирования продукта по слудующим критериям:
- вначале на машине дорабатывается тот продукт, который указан в начальном состоянии, на количество дней указанное в remain_day
- далее либо продолжается тот-же продукт, либо указывается переход на другой продукт длительностью 2 дня и далее планируется уже другой продукт
- для указания чистки существует специальный продукт с индексом 0 PRODUCT_ZERO
- есть ограничения на переходы - в один день не более 3-х переходов - max_daily_prod_zero
- ограничение на типы машин, для продукта с machine_type > 0 разрешены машины только type=machine_type, если machine_type = 0 то можно на любой машине
- не более одного перехода 
- если есть чистка в на машине в определенный день, то машина пропускает день производства
- мягкое ограничение - минимизировать отклонение от заданных пропорций qty
- использование длины партии lday:
	1.1 каждый продукт вырабатывается партиями длиной lday 
	1.2 переход можно использовать только после окончания партии
	1.3 reamin_day - это количество остатка партии на начало периода
- если индекс продукта на машине product_idx=0,то на ней можно начинать любой продукт
- если указано qty_minus = 0, то можно планировать количество меньше чем во входных данных, если =1, то количество плана не меньше, чем во входных данных


функция оптимального результата - минимум отклонений от пропорций и минимум переходов: model.Minimize(sum(proportion_objective_terms) + product_counts[PRODUCT_ZERO] * downtime_penalty)


Environment configuration (loaded via pydantic-settings from .env)
# LOOM
LOOM_MAX_TIME=600 - максимальное время расчета
CALC_TEST_DATA=false - укзаывает на признак тестового запуска
SOLVER_ENUMERATE=false - режим расчета                                     
APPLY_QTY_MINUS=false - переопределение логики расчета - отключение использования 
APPLY_INDEX_UP=false - логика выбора другого артикула для планирования: если true, то индекс следующего продукта на машине должен быть больше текущего (для исключения прижков: продукт 1, затем продукт 2, затем опять продукт 1)

Run the server
- With .env configured: run.cmd

Run for testing (planing data from file example/test_in.json)
.env: CALC_TEST_DATA=true
тогда запуститься процедура calc_test_data_from в main.py, а не сервер 

