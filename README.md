## Project overview
- Python/FastAPI server планирования расписания производства

Главная библиотека для расчета расписания - ortools
pydantic - используется для API

Реализован один расчет @router.post("/plan") для ткацкого производства (функция create_model)

## Описание модели:
существующая модель для планирования продукта по слудующим критериям:
- вначале на машине дорабатывается тот продукт, который указан в начальном состоянии, на количество дней указанное в remain_day
- далее либо продолжается тот-же продукт, либо указывается переход на другой продукт длительностью 2 дня и далее планируется уже другой продукт
- для указания чистки существует специальный продукт с индексом 0 PRODUCT_ZERO
- есть ограничения на переходы - в один день не более 3-х переходов - max_daily_prod_zero
- ограничение на типы машин, для продукта с machine_type > 0 разрешены машины только type=machine_type, если machine_type = 0 то можно на любой машине
- не более одного перехода 
- если есть чистка в на машине в определенный день, то машина пропускает день производства
- мягкое ограничение - минимизировать отклонение от заданных пропорций qty
- использование длины партии lday:
	1.1 каждый продукт вырабатывается партиями длиной lday 
	1.2 переход можно использовать только после окончания партии
	1.3 reamin_day - это количество остатка партии на начало периода
- если индекс продукта на машине product_idx=0,то на ней можно начинать любой продукт
- если указано qty_minus = 0, то можно планировать количество меньше чем во входных данных, если =1, то количество плана не меньше, чем во входных данных


функция оптимального результата - минимум отклонений от пропорций и минимум переходов: model.Minimize(sum(proportion_objective_terms) + product_counts[PRODUCT_ZERO] * downtime_penalty)


## Режимы горизонта планирования (HORIZON_MODE)

Система поддерживает несколько режимов работы с разной длиной горизонта:

### FULL (по умолчанию)
Полная модель со всеми ограничениями. Используется для коротких горизонтов (до ~30 смен).
- Учитывает длительность партий (lday), переходы между продуктами
- Чистки (cleans) исключаются из рабочих дней модели
- Подходит для точного краткосрочного планирования

### LONG_SIMPLE
Упрощённая модель для длинных горизонтов (81+ смен).
- 1 модельный день = 3 фактические смены
- Все дни считаются рабочими (cleans НЕ исключают дни из домена переменных)
- Чистки учитываются отдельно при построении расписания
- Эвристики H1-H3 для начальных продуктов
- Унимодальность профилей (рост → спад, без горок)
- Помашинная непрерывность (один сегмент на продукт)

### LONG_SIMPLE_HINT
То же что LONG_SIMPLE, но с жадным hint для ускорения поиска решения.

### LONG_TWO_PHASE
Двухфазный режим для очень больших задач с разделением по цехам (div).

**Фаза 1 (Phase 1):**
- Задача разбивается по цехам (div=1, div=2, ...)
- Для каждого цеха запускается ОТДЕЛЬНЫЙ подпроцесс с режимом LONG_SIMPLE
- Входные данные: исходные смены (count_days в сменах)
- Результат: множество допустимых продуктов для каждой машины (allowed_products)
- JSON-дампы для отладки: `log/debug_phase1_div_{N}.json`, `log/result_phase1_div_{N}.json`

**Фаза 2 (Phase 2):**
- После завершения Phase 1 выполняется конверсия смен → дни (count_days / 3)
- Строится итоговая модель create_model_simple с ограниченными доменами (allowed_products)
- Решается полная задача с учётом результатов Phase 1

**Важные особенности:**
- Конверсия смен в дни (`convert_shifts_to_days`) для LONG_TWO_PHASE происходит ПОСЛЕ Phase 1
- В solver_result() simple_mode=True для всех LONG* режимов → cleans не исключают дни из расписания
- Продукты с lday <= 0 автоматически получают lday = 10 перед построением модели

### Переменные окружения для LONG_TWO_PHASE
- `TEST_INPUT_FILE` — путь к входному JSON для подпроцесса
- `HORIZON_MODE=LONG_SIMPLE` — режим подпроцесса (внутренний)
- `SAVE_RESULT_JSON_PATH` — путь для сохранения результата подпроцесса
- `CALC_TEST_DATA=true` — флаг тестового запуска

